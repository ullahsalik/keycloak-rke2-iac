

- name: Create .kube directory
  file:
    path: "{{ ansible_env.HOME }}/.kube"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: directory
    mode: 0755

- name: Check the value of ansible_user_dir
  debug:
    var: ansible_user_dir

- name: Copy kubeconfig from RKE2 to user home
  copy:
    src: /etc/rancher/rke2/rke2.yaml
    dest: "/home/{{ ansible_user }}/.kube/config"
    remote_src: true
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0644

- name: Replace server address with localhost
  replace:
    path: "/home/{{ ansible_user }}/.kube/config"
    regexp: '127.0.0.1'
    replace: 'localhost'

- name: Export RKE2 binaries globally
  copy:
    dest: /etc/profile.d/rke2.sh
    content: |
      export PATH=$PATH:{{ rke2_bin_path }}

- name: Wait for Kubernetes API
  shell: "{{ rke2_bin_path }}/kubectl get nodes"
  register: kubectl_ready
  retries: 20
  delay: 10
  until: kubectl_ready.rc == 0