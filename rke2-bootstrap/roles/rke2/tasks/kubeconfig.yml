- name: Wait for Kubernetes API
  shell: "{{ rke2_bin_path }}/kubectl get nodes"
  register: kubectl_ready
  retries: 20
  delay: 10
  until: kubectl_ready.rc == 0

- name: Create .kube directory
  file:
    path: "{{ ansible_env.HOME }}/.kube"
    state: directory
    mode: 0755

- name: Copy kubeconfig
  copy:
    src: "{{ kubeconfig_path }}"
    dest: "{{ ansible_env.HOME }}/.kube/config"
    remote_src: yes
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0644

- name: Replace server address with localhost
  replace:
    path: "{{ ansible_env.HOME }}/.kube/config"
    regexp: '127.0.0.1'
    replace: 'localhost'

- name: Export RKE2 binaries globally
  copy:
    dest: /etc/profile.d/rke2.sh
    content: |
      export PATH=$PATH:{{ rke2_bin_path }}